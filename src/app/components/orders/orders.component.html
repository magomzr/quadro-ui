<div class="orders-container">
  <div class="orders-header">
    <h2>Gesti√≥n de √ìrdenes</h2>
    <div class="orders-stats">
      <span class="stat">Total: {{ totalItems }} √≥rdenes</span>
    </div>
  </div>

  <!-- Filtros -->
  <div class="filters">
    <div class="filter-group">
      <label>Estado:</label>
      <select [(ngModel)]="statusFilter" (change)="onFilterChange()">
        <option value="">Todos</option>
        <option value="pending">Pendiente</option>
        <option value="paid">Pagado</option>
        <option value="cancelled">Cancelado</option>
      </select>
    </div>
    <div class="filter-group">
      <label>Desde:</label>
      <input
        type="date"
        [(ngModel)]="dateFromFilter"
        (change)="onFilterChange()"
      />
    </div>
    <div class="filter-group">
      <label>Hasta:</label>
      <input
        type="date"
        [(ngModel)]="dateToFilter"
        (change)="onFilterChange()"
      />
    </div>
  </div>

  @if (loading) {
  <div class="loading">Cargando √≥rdenes...</div>
  } @if (error) {
  <div class="error-message">{{ error }}</div>
  } @if (orders.length > 0) {
  <!-- Tabla de √≥rdenes -->
  <div class="orders-table-container">
    <table class="orders-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Cliente</th>
          <th>Estado</th>
          <th>Total</th>
          <th>Descuento</th>
          <th>Items</th>
          <th>Fecha</th>
          <th>Cambiar Estado</th>
        </tr>
      </thead>
      <tbody>
        @for (order of orders; track order.id) {
        <tr>
          <td class="order-id">{{ order.id.substring(0, 8) }}...</td>
          <td>
            <div class="customer-info">
              <div class="customer-name">
                {{ order.customerName }}
                @if (order.customerId) {
                <button
                  class="customer-link"
                  (click)="viewCustomer(order)"
                  title="Ver detalles del cliente"
                >
                  üë§
                </button>
                }
              </div>
              <div class="customer-email">{{ order.customerEmail }}</div>
            </div>
          </td>
          <td>
            <span class="status-badge" [class]="getStatusClass(order.status)">
              {{ order.status }}
            </span>
          </td>
          <td class="order-total">${{ order.total }}</td>
          <td class="order-discount">
            @if (order.discount) {
            <div class="discount-info">
              <span class="discount-code">{{ order.discount.code }}</span>
              <span class="discount-amount">-${{ order.discountAmount }}</span>
            </div>
            } @else {
            <span class="no-discount">Sin descuento</span>
            }
          </td>
          <td class="items-count">{{ order._count.orderItems }}</td>
          <td class="order-date">{{ order.createdAt | date : "short" }}</td>
          <td class="actions">
            <select
              class="status-select"
              [value]="order.status"
              (change)="updateStatus(order, $any($event.target).value)"
            >
              <option value="pending">Pendiente</option>
              <option value="paid">Pagado</option>
              <option value="cancelled">Cancelado</option>
            </select>
          </td>
        </tr>
        }
      </tbody>
    </table>
  </div>

  <!-- Paginaci√≥n -->
  <div class="pagination">
    <button
      [disabled]="currentPage === 1"
      (click)="changePage(currentPage - 1)"
    >
      Anterior
    </button>
    <span class="page-info">
      P√°gina {{ currentPage }} de {{ totalPages }}
    </span>
    <button
      [disabled]="currentPage === totalPages"
      (click)="changePage(currentPage + 1)"
    >
      Siguiente
    </button>
  </div>
  } @else if (!loading) {
  <div class="no-orders">No hay √≥rdenes para mostrar</div>
  }
</div>

<!-- Modal de Customer -->
@if (showCustomerModal) {
<div class="modal-overlay" (click)="closeCustomerModal()">
  <div class="customer-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Informaci√≥n del Cliente</h3>
      <button class="close-btn" (click)="closeCustomerModal()">‚úï</button>
    </div>

    <div class="modal-content">
      @if (loadingCustomer) {
      <div class="modal-loading">Cargando informaci√≥n del cliente...</div>
      } @else if (customerError) {
      <div class="modal-error">{{ customerError }}</div>
      } @else if (selectedCustomer) {
      <div class="customer-details">
        <div class="customer-avatar">
          {{ selectedCustomer.name.charAt(0).toUpperCase() }}
        </div>

        <div class="customer-info-detailed">
          <h4>{{ selectedCustomer.name }}</h4>

          <div class="detail-row">
            <span class="label">Email:</span>
            <span class="value">{{ selectedCustomer.email }}</span>
          </div>

          <div class="detail-row">
            <span class="label">Tel√©fono:</span>
            <span class="value">{{ selectedCustomer.phone }}</span>
          </div>

          <div class="detail-row">
            <span class="label">Direcci√≥n:</span>
            <span class="value">{{ selectedCustomer.address }}</span>
          </div>

          <div class="detail-row">
            <span class="label">Cliente desde:</span>
            <span class="value">{{
              formatDate(selectedCustomer.createdAt)
            }}</span>
          </div>

          @if (selectedCustomer.updatedAt !== selectedCustomer.createdAt) {
          <div class="detail-row">
            <span class="label">√öltima actualizaci√≥n:</span>
            <span class="value">{{
              formatDate(selectedCustomer.updatedAt)
            }}</span>
          </div>
          }

          <div class="customer-id">ID: {{ selectedCustomer.id }}</div>
        </div>
      </div>
      }
    </div>
  </div>
</div>
}
