<div class="orders-container">
  <div class="orders-header">
    <h2>{{ "title" | label : "orders" }}</h2>
    <div class="orders-stats">
      <span class="stat"
        >{{ "total" | label : "common" }}: {{ totalItems }}
        {{ "ordersCount" | label : "orders" }}</span
      >
    </div>
  </div>

  <!-- Filtros -->
  <div class="filters">
    <div class="filter-group">
      <label>{{ "status" | label : "orders" }}:</label>
      <select [(ngModel)]="statusFilter" (change)="onFilterChange()">
        <option value="">{{ "all" | label : "orders" }}</option>
        <option value="pending">{{ "pending" | label : "orders" }}</option>
        <option value="paid">{{ "paid" | label : "orders" }}</option>
        <option value="cancelled">{{ "cancelled" | label : "orders" }}</option>
      </select>
    </div>
    <div class="filter-group">
      <label>{{ "from" | label : "orders" }}:</label>
      <input
        type="date"
        [(ngModel)]="dateFromFilter"
        (change)="onFilterChange()"
      />
    </div>
    <div class="filter-group">
      <label>{{ "to" | label : "orders" }}:</label>
      <input
        type="date"
        [(ngModel)]="dateToFilter"
        (change)="onFilterChange()"
      />
    </div>
  </div>

  @if (loading) {
  <div class="loading">Cargando Ã³rdenes...</div>
  } @if (error) {
  <div class="error-message">{{ error }}</div>
  } @if (orders.length > 0) {
  <!-- Tabla de Ã³rdenes -->
  <div class="orders-table-container">
    <table class="orders-table">
      <thead>
        <tr>
          <th>{{ "id" | label : "orders" }}</th>
          <th>{{ "client" | label : "orders" }}</th>
          <th>{{ "status" | label : "orders" }}</th>
          <th>{{ "total" | label : "orders" }}</th>
          <th>{{ "discount" | label : "orders" }}</th>
          <th>{{ "items" | label : "orders" }}</th>
          <th>{{ "date" | label : "orders" }}</th>
          <th>{{ "changeStatus" | label : "orders" }}</th>
        </tr>
      </thead>
      <tbody>
        @for (order of orders; track order.id) {
        <tr>
          <td class="order-id">{{ order.id.substring(0, 8) }}...</td>
          <td>
            <div class="customer-info">
              <div class="customer-name">
                {{ order.customerName }}
                @if (order.customerId) {
                <button
                  class="customer-link"
                  (click)="viewCustomer(order)"
                  title="Ver detalles del cliente"
                >
                  ðŸ‘¤
                </button>
                }
              </div>
              <div class="customer-email">{{ order.customerEmail }}</div>
            </div>
          </td>
          <td>
            <span class="status-badge" [class]="getStatusClass(order.status)">
              {{ order.status }}
            </span>
          </td>
          <td class="order-total">${{ order.total }}</td>
          <td class="order-discount">
            @if (order.discount) {
            <div class="discount-info">
              <span class="discount-code">{{ order.discount.code }}</span>
              <span class="discount-amount">-${{ order.discountAmount }}</span>
            </div>
            } @else {
            <span class="no-discount">{{
              "noDiscount" | label : "orders"
            }}</span>
            }
          </td>
          <td class="items-count">{{ order._count.orderItems }}</td>
          <td class="order-date">{{ order.createdAt | date : "short" }}</td>
          <td class="actions">
            <select
              class="status-select"
              [value]="order.status"
              (change)="updateStatus(order, $any($event.target).value)"
            >
              <option value="pending">Pendiente</option>
              <option value="paid">Pagado</option>
              <option value="cancelled">Cancelado</option>
            </select>
          </td>
        </tr>
        }
      </tbody>
    </table>
  </div>

  <!-- PaginaciÃ³n -->
  <div class="pagination">
    <button
      [disabled]="currentPage === 1"
      (click)="changePage(currentPage - 1)"
    >
      Anterior
    </button>
    <span class="page-info">
      PÃ¡gina {{ currentPage }} de {{ totalPages }}
    </span>
    <button
      [disabled]="currentPage === totalPages"
      (click)="changePage(currentPage + 1)"
    >
      Siguiente
    </button>
  </div>
  } @else if (!loading) {
  <div class="no-orders">{{ "noOrders" | label : "orders" }}</div>
  }
</div>

<!-- Modal de Customer -->
@if (showCustomerModal) {
<div class="modal-overlay" (click)="closeCustomerModal()">
  <div class="customer-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ "customerInfo" | label : "orders" }}</h3>
      <button class="close-btn" (click)="closeCustomerModal()">âœ•</button>
    </div>

    <div class="modal-content">
      @if (loadingCustomer) {
      <div class="modal-loading">
        {{ "loadingCustomer" | label : "orders" }}
      </div>
      } @else if (customerError) {
      <div class="modal-error">{{ customerError }}</div>
      } @else if (selectedCustomer) {
      <div class="customer-details">
        <div class="customer-avatar">
          {{ selectedCustomer.name.charAt(0).toUpperCase() }}
        </div>

        <div class="customer-info-detailed">
          <h4>{{ selectedCustomer.name }}</h4>

          <div class="detail-row">
            <span class="label">Email:</span>
            <span class="value">{{ selectedCustomer.email }}</span>
          </div>

          <div class="detail-row">
            <span class="label">TelÃ©fono:</span>
            <span class="value">{{ selectedCustomer.phone }}</span>
          </div>

          <div class="detail-row">
            <span class="label">DirecciÃ³n:</span>
            <span class="value">{{ selectedCustomer.address }}</span>
          </div>

          <div class="detail-row">
            <span class="label">{{ "customerSince" | label : "orders" }}:</span>
            <span class="value">{{
              formatDate(selectedCustomer.createdAt)
            }}</span>
          </div>

          @if (selectedCustomer.updatedAt !== selectedCustomer.createdAt) {
          <div class="detail-row">
            <span class="label">{{ "lastUpdate" | label : "orders" }}:</span>
            <span class="value">{{
              formatDate(selectedCustomer.updatedAt)
            }}</span>
          </div>
          }

          <div class="customer-id">ID: {{ selectedCustomer.id }}</div>
        </div>
      </div>
      }
    </div>
  </div>
</div>
}
